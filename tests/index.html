<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
		<meta name="HandheldFriendly" content="true" />
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<meta name="apple-mobile-web-app-title" content="VirtualDialScan"/>
		<meta name="viewport" content="initial-scale=1 maximum-scale=1 user-scalable=0 minimal-ui" />
		<link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
		<link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
		<link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
		<link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
		<link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
		<link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
		<link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
		<link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
		<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
		<link rel="manifest" href="/manifest.json">
		<meta name="msapplication-TileColor" content="#ffffff">
		<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
		<meta name="theme-color" content="#ffffff">
        <title>VirtualDialScan</title>
        <script src="//cdn.jsdelivr.net/phaser/2.5.0/phaser.min.js"></script>
		
		
		
		
		
    </head>
    <body style="padding:0px; margin:0px;">
	<input type="file" id="fileChooser" onchange="handleFiles(this.files)" style="display:none" />
    <script type="text/javascript">

	function getJsonFromUrl() {
	  var query = location.search.substr(1);
	  var result = {};
	  query.split("&").forEach(function(part) {
		var item = part.split("=");
		result[item[0]] = decodeURIComponent(item[1]);
	  });
	  return result;
	}
	
	var positionToPlaceImage = "";
	
	function handleFiles(files)
	{
	
		// Loop through the FileList and render image files as thumbnails.
		for (var i = 0, f; f = files[i]; i++) {
			selectedImageName = f.name;
			
			var reader = new FileReader();

			// Closure to capture the file information.
			reader.onload = (function(theFile) {
				return function(e) {
					dataURI = e.target.result;
					var data = new Image();
					data.src = dataURI;
					try {
					game.cache.removeImage(positionToPlaceImage+'image');
					} catch(e) {};
					
					game.cache.addImage(positionToPlaceImage+'image', dataURI, data);
					
					if(positionToPlaceImage == "TL") {
						buttonTopL.loadTexture(positionToPlaceImage+'image', 0);
						ResizeButton(buttonTopL, finalImageWidth);
					} else if(positionToPlaceImage == "TM") {
						buttonTopM.loadTexture(positionToPlaceImage+'image', 0);
						ResizeButton(buttonTopM, finalImageWidth);
					} else if(positionToPlaceImage == "TR") {
						buttonTopR.loadTexture(positionToPlaceImage+'image', 0);
						ResizeButton(buttonTopR, finalImageWidth);
					} else if(positionToPlaceImage == "ML") {
						buttonMiddleL.loadTexture(positionToPlaceImage+'image', 0);
						ResizeButton(buttonMiddleL, finalImageWidth);
					} else if(positionToPlaceImage == "MR") {
						buttonMiddleR.loadTexture(positionToPlaceImage+'image', 0);
						ResizeButton(buttonMiddleR, finalImageWidth);
					} else if(positionToPlaceImage == "BL") {
						buttonBottomL.loadTexture(positionToPlaceImage+'image', 0);
						ResizeButton(buttonBottomL, finalImageWidth);
					} else if(positionToPlaceImage == "BM") {
						buttonBottomM.loadTexture(positionToPlaceImage+'image', 0);
						ResizeButton(buttonBottomM, finalImageWidth);
					} else if(positionToPlaceImage == "BR") {
						buttonBottomR.loadTexture(positionToPlaceImage+'image', 0);
						ResizeButton(buttonBottomR, finalImageWidth);
						
					}
				};
			})(f);

			// Read in the image file as a data URL.
			reader.readAsDataURL(f);
		}
	}
	
	var toolbarSz = window.innerWidth*.15;
	var gameWidth = window.innerWidth-1-toolbarSz;
	var gameHeight = window.innerHeight-1;
	var contra;
	var padd = 20;
	var finalImageWidth = Math.min(gameWidth/3, gameHeight/3) - padd*2;
	var move = true;
	var speed = 5;
	var urlData = getJsonFromUrl();
	var buttonTopL, buttonTopM, buttonTopR, buttonMiddleL, buttonMiddleR, buttonBottomL, buttonBottomM, buttonBottomR;
	var buttonNextLevel, buttonPreviousLevel;
	var toolbar;
	var rectangleTL, rectangleTM, rectangleTR, rectangleML, rectangleMR, rectangleBL, rectangleBM, rectangleBR;
	var bgColor = '0xffffff';
	var tintColor = 'rgba(255,255,255, 0.3)';
	var game;
	var toolbarColor = '#ffffff';
	var toolbarGrp;
	var currentSchema = 0;
	var toolbarButtonClicked = 0;
	
	if(urlData["speed"] != undefined)
	{
		speed = urlData["speed"];
	}
	
	function preload() {
		game.load.image('arrow', 'arrow.png');
		game.load.image('buttonPlus','set1/plus.png');
		game.load.image('buttonMinus','set1/minus.png');
		game.load.image('buttonAdd','set1/file_add.png');
		game.load.image('buttonSearch','set1/file_search.png');
		//game.load.image('buttonNoPic','set1/nopic.png');
		
		 game.load.spritesheet('buttonNoPic', 'set1/nopic.png', 128, 128)
	}
	
	function changeSchema()
	{
		currentSchema+=1;
		if(currentSchema == 3)
		{
			currentSchema = 0; //only 3 schemas available at the moment...
		}
		
		switch(currentSchema)
		{
			case 0:
				game.stage.backgroundColor = '#000000';
				tintColor = 'rgba(255,255,255, 0.3)';
				toolbarColor = '#ffffff'
				break;
			case 1:
				game.stage.backgroundColor = '#ffffff';
				tintColor = 'rgba(0,255,0, 0.3)';
				toolbarColor = '#555555'
				break;
			case 2:
				game.stage.backgroundColor = '#E6E6FA';
				tintColor = 'rgba(0,255,255, 0.3)';
				toolbarColor = '#66eeff'
				break;
			default:
				game.stage.backgroundColor = '#000000';
				tintColor = 'rgba(255,255,255, 0.3)';
				toolbarColor = '#ffffff'
				break;
		}

		//redraw toolbar
		drawRectangle(toolbar);
				
		//move toolbar buttons to the top
		toolbarGrp.bringToTop();

		toolbarButtonClicked = 1;
		move = 1;
	}
	
	function drawRectangle(rect)
	{
		var drawObj;
		var width = rect.width;
		var height = rect.height;
		var bmd = game.add.bitmapData(width, height);
		 
		bmd.ctx.beginPath();
		bmd.ctx.rect(0, 0, width, height);
		bmd.ctx.fillStyle = toolbarColor;
		bmd.ctx.fill();
		drawObj = game.add.sprite(rect.x, rect.y, bmd);
		drawObj.anchor.setTo(0.0, 0.0);

		backgrndGrp.add(drawObj);
	}

	function create() {

		//	Enable p2 physics
		game.physics.startSystem(Phaser.Physics.P2JS);
		
		key1 = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
		key1.onDown.add(onClick, this);
		
		key2 = game.input.keyboard.addKey(Phaser.Keyboard.ENTER);
		key2.onDown.add(onClick, this);
		
		game.input.onTap.add(onClick, this);
		game.input.priorityID = 1;
		toolbar = new Phaser.Rectangle(gameWidth, 0, toolbarSz, gameHeight);
		
		backgrndGrp = game.add.group();
		toolbarGrp = game.add.group();
		
		drawRectangle(toolbar);
		
		buttonNextLevel = game.add.button(toolbar.x + padd, toolbar.y + padd, 'buttonPlus', nextLevel, this, 1, 0, 0);
		//buttonNextLevel.width = toolbar.width/3;
		buttonNextLevel.scale.setTo(toolbar.width/3/buttonNextLevel.width, toolbar.width/3/buttonNextLevel.width);
		buttonPreviousLevel = game.add.button(toolbar.x + toolbar.width/3*2 - padd, toolbar.y + padd, 'buttonMinus', previousLevel, this, 1, 0, 0);
		buttonPreviousLevel.scale.setTo(toolbar.width/3/buttonPreviousLevel.width, toolbar.width/3/buttonPreviousLevel.width);
		
		buttonChangeColorSchema = game.add.button(toolbar.x + padd, toolbar.y + padd*2 + buttonNextLevel.height, 'buttonSearch', changeSchema, this, 1, 0, 0);
		buttonChangeColorSchema.scale.setTo(toolbar.width/3/buttonChangeColorSchema.width, toolbar.width/3/buttonChangeColorSchema.width);
		buttonChangeColorSchema.input.priorityID = 1;
		
		toolbarGrp.add(buttonNextLevel);
		toolbarGrp.add(buttonPreviousLevel);
		toolbarGrp.add(buttonChangeColorSchema);
		
		
		buttonTopL = game.add.button(padd, padd, 								'buttonNoPic', browseForImage, this, 1, 0, 0);
		buttonTopL.name = "TL";
		rectangleTL = new Phaser.Rectangle(padd, padd, finalImageWidth, finalImageWidth);

		buttonTopM = game.add.button(gameWidth/2 - finalImageWidth/2, padd, 	'buttonNoPic', browseForImage, this, 1, 0, 0);
		buttonTopM.name = "TM";
		rectangleTM = new Phaser.Rectangle(gameWidth/2 - finalImageWidth/2, padd, finalImageWidth, finalImageWidth);
		
		buttonTopR = game.add.button(gameWidth - finalImageWidth - padd, padd, 	'buttonNoPic', browseForImage, this, 1, 0, 0);
		buttonTopR.name = "TR";
		rectangleTR = new Phaser.Rectangle(gameWidth - finalImageWidth - padd, padd, finalImageWidth, finalImageWidth);
		
		buttonMiddleL = game.add.button(padd, gameHeight/2 - finalImageWidth/2, 								'buttonNoPic', browseForImage, this, 1, 0, 0);
		buttonMiddleL.name = "ML";
		rectangleML = new Phaser.Rectangle(padd, gameHeight/2 - finalImageWidth/2, finalImageWidth, finalImageWidth);
		
		buttonMiddleR = game.add.button(gameWidth - finalImageWidth - padd, gameHeight/2 - finalImageWidth/2, 	'buttonNoPic', browseForImage, this, 1, 0, 0);
		buttonMiddleR.name = "MR";
		rectangleMR = new Phaser.Rectangle(gameWidth - finalImageWidth - padd, gameHeight/2 - finalImageWidth/2, finalImageWidth, finalImageWidth);
		
		buttonBottomL = game.add.button(padd, gameHeight - finalImageWidth - padd, 'buttonNoPic', browseForImage, this, 1, 0, 0);
		buttonBottomL.name = "BL";
		rectangleBL= new Phaser.Rectangle(padd, gameHeight - finalImageWidth - padd, finalImageWidth, finalImageWidth);
		
		buttonBottomM = game.add.button(gameWidth/2 - finalImageWidth/2, gameHeight - finalImageWidth - padd, 'buttonNoPic', browseForImage, this, 1, 0, 0);
		buttonBottomM.name = "BM";
		rectangleBM= new Phaser.Rectangle(gameWidth/2 - finalImageWidth/2, gameHeight - finalImageWidth - padd, finalImageWidth, finalImageWidth);
		
		buttonBottomR = game.add.button(gameWidth - finalImageWidth - padd, gameHeight - finalImageWidth - padd, 'buttonNoPic', browseForImage, this, 1, 0, 0);
		buttonBottomR.name = "BR";
		rectangleBR= new Phaser.Rectangle(gameWidth - finalImageWidth - padd, gameHeight - finalImageWidth - padd, finalImageWidth, finalImageWidth);
		
		ResizeButton(buttonTopL, finalImageWidth);
		ResizeButton(buttonTopM, finalImageWidth);
		ResizeButton(buttonTopR, finalImageWidth);
		
		ResizeButton(buttonMiddleL, finalImageWidth);
		ResizeButton(buttonMiddleR, finalImageWidth);
		
		ResizeButton(buttonBottomR, finalImageWidth);
		ResizeButton(buttonBottomM, finalImageWidth);
		ResizeButton(buttonBottomL, finalImageWidth);
		
		//buttonBottomL.tint = 0xffffff;
		
		contra = game.add.sprite(gameWidth/2,gameHeight/2, 'arrow');
		//Enable the physics body on this sprite and turn off the visual debugger
		game.physics.p2.enable(contra, true);
					
		//100% W is 1152px
		var minProportion = Math.min(gameWidth, gameHeight);
		var arrowProportion = minProportion / 750;
		
		//	Clear the shapes and load the 'arrow' polygon from the physicsData JSON file in the cache
		contra.body.clearShapes();
		contra.scale.setTo(arrowProportion, arrowProportion);
	}

	function nextLevel()
	{
		if(speed < 5)
		{
			speed+=1;
		}
		else
		{
			speed+=5;
		}
		
		toolbarButtonClicked = 1;
		move = 1;
	}
	
	function previousLevel()
	{
		if(speed > 1)
		{
			if(speed <= 5)
			{
				speed-=1;
			}
			else
			{
				speed -= 5;
			}
		}
		
		toolbarButtonClicked = 1;
		move = 1;
	}

	function ResizeButton(button, width)
	{
		//100% of images should be finalImageWidth
		//calculate maximum image (width or height)
		var maxImg = Math.max(button.width, button.height);
		var proportion = width/maxImg;
		
		button.scale.setTo(proportion, proportion);
	}

	function browseForImage(button, pointer) 
	{
		console.log('you clicked', button.name);
		positionToPlaceImage = button.name;
		document.getElementById("fileChooser").click();
		
		
		// this is how you load an image dinamically and change the sprite
		//this.game.load.image('profilepic','http://www.w3school.com.cn/i/ct_html5_canvas_image.gif');
		//contra.loadTexture('profilepic', 0);
	}

	function onClick()
	{	
		if (toolbarButtonClicked == 1)
		{
			toolbarButtonClicked = 0;
		}
		else
		{
			move = !move;
			if (move == false)
			{
				contra.body.rotateRight(0);
				
				//TODO: if we stopped, we should show whatever image is selected!
				//check the frame names of the button that we are hitting!
				
				button = getSelectedButton();
				console.log('button name: ', button.name);
				
				//
				//if button.key != buttonNoPic
				//
				
			}
		}
	}
	
	function getSelectedButton()
	{
		var button;
		var angle = contra.body.angle;
		if(angle > -22.5 && angle <= 22.5)
		{
			button = buttonMiddleR;
		}
		else if(angle > 22.5 && angle <= 67.5)
		{
			button = buttonBottomR;
		}
		else if(angle > 67.5 && angle <= 112.5)
		{
			button = buttonBottomM;
		}
		else if(angle > 112.5 && angle <= 157.5)
		{
			button = buttonBottomL;
		}
		else if(angle > 157.5 || angle <= -157.5)
		{
			button = buttonMiddleL;
		}
		else if(angle > -157.5 && angle <= -112.5)
		{
			button = buttonTopL;
		}
		else if(angle > -112.5 && angle <= -67.5)
		{
			button = buttonTopM;
		}
		else if(angle > -67.5 && angle <= -22.5)
		{
			button = buttonTopR;
		}
		
		return button;
	}
	
	function update() {

		if (move)
		{
			contra.body.rotateRight(speed);
		}

		button = getSelectedButton();
		//console.log('selectable button name: ', button.name);
		
		
	}

	function render() {
		
		//game.debug.geom(toolbar,'rgba(255,255,255, 0.9)');
		
		button = getSelectedButton();
		if(button.name == "TL")	{
			game.debug.geom(rectangleTL,tintColor);
		} else if(button.name == "TM") {
			game.debug.geom(rectangleTM,tintColor);
		} else if(button.name == "TR") {
			game.debug.geom(rectangleTR,tintColor);
		} else if(button.name == "ML") {
			game.debug.geom(rectangleML,tintColor);
		} else if(button.name == "MR") {
			game.debug.geom(rectangleMR,tintColor);
		} else if(button.name == "BL") {
			game.debug.geom(rectangleBL,tintColor);
		} else if(button.name == "BM") {
			game.debug.geom(rectangleBM,tintColor);
		} else if(button.name == "BR") {
			game.debug.geom(rectangleBR,tintColor);
		}
	}
	
    window.onload = function() {
		game = new Phaser.Game(gameWidth+toolbarSz, gameHeight, Phaser.CANVAS, 'VirtualDialScan', { preload: preload, create: create, update: update, render: render });
		//game.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;
    };

    </script>

    </body>
</html>